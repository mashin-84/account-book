<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#666666">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>記帳系統</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

    :root {
      --bg: #ffffff;
      --card-bg: #f8f8f8;
      --accent: #666;
      --text: #222;
      --muted: #aaa;
      --border: #ddd;
      --icon-bg: #efefef;
      --highlight: #cccccc;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      padding: 60px;
      background: var(--bg);
      font-size: 56px;
      color: var(--text);
    }

    h2, h3 {
      margin-bottom: 40px;
      font-size: 64px;
      color: #000;
    }

    label {
      display: block;
      margin-top: 40px;
      font-size: 56px;
    }

    select, input, button {
      width: 100%;
      padding: 40px;
      font-size: 56px;
      margin-top: 20px;
      border-radius: 20px;
      border: 2px solid var(--border);
      box-sizing: border-box;
      background: var(--card-bg);
      color: var(--text);
    }

    input[type="number"] {
      color: #000;
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      margin-top: 40px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover:not(:disabled) {
      background: #444;
    }

    button:disabled {
      background: var(--muted);
      cursor: not-allowed;
    }

    .message {
      margin-top: 40px;
      color: var(--accent);
      font-weight: bold;
      font-size: 56px;
    }

    .toggle-btn {
      background: var(--card-bg);
      color: var(--accent);
      font-weight: bold;
      font-size: 56px;
      margin-top: 60px;
      padding: 40px;
      border-radius: 20px;
      border: 2px solid var(--border);
      width: 100%;
      box-sizing: border-box;
    }

    .section {
      display: none;
    }

    .active {
      display: block;
    }

    .category-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .category-btn {
      background: var(--icon-bg);
      border: 2px solid transparent;
      border-radius: 20px;
      padding: 20px;
      font-size: 48px;
      text-align: center;
      cursor: pointer;
      color: #333;
    }

    .category-btn.selected {
      border-color: var(--accent);
      background: var(--highlight);
      font-weight: bold;
    }

    .hidden {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 40px;
      font-size: 48px;
      background: var(--card-bg);
      color: var(--text);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 6px rgba(0,0,0,0.05);
    }

    th, td {
      border: 1px solid var(--border);
      padding: 24px;
      text-align: left;
    }

    th {
      background-color: var(--highlight);
      color: #000;
    }

    .card-table {
      display: table;
      width: 100%;
      margin-top: 40px;
    }

    .card-row {
      display: table-row;
    }

    .card-cell {
      display: table-cell;
      background: var(--card-bg);
      padding: 20px;
      border: 1px solid var(--border);
      vertical-align: top;
      text-align: center;
    }

    .card-title {
      font-weight: bold;
      font-size: 28px;
      margin-bottom: 12px;
    }

    .card-balance {
      font-size: 32px;
      color: var(--text);
    }
  </style>
</head>
<body>
  <div id="inputSection" class="section active">
    <h2>記帳輸入</h2>
    <form id="form">
      <label>類型<select id="type" required><option value="收入">收入</option><option value="支出">支出</option></select></label>
      <label>日期<input type="date" id="date" required></label>
      <label>帳戶<select id="account" required></select></label>
      <label>類別</label>
      <div id="categoryButtons" class="category-buttons"></div>
      <select id="category" class="hidden" required></select>
      <label>金額<input type="number" id="amount" required></label>
      <label>花費內容<input type="text" id="note"></label>
      <button type="submit">提交</button>
    </form>
    <div class="message" id="message"></div>
    <button class="toggle-btn" onclick="switchTo('balances')">顯示帳戶餘額</button>
    <button class="toggle-btn" onclick="switchTo('category')">類別管理</button>
    <button class="toggle-btn" onclick="switchTo('records')">查看記帳紀錄</button>
  </div>

  <div id="balancesSection" class="section">
    <h2>帳戶餘額</h2>
    <div id="balances" class="card-table">載入中...</div>
    <button class="toggle-btn" onclick="switchTo('input')">🔙 返回輸入頁</button>
  </div>

  <div id="categorySection" class="section">
    <h2>類別管理</h2>
    <h3>新增類別</h3>
    <form id="addCategoryForm">
      <label>類型<select id="newType"><option value="收入">收入</option><option value="支出">支出</option></select></label>
      <label>類別名稱<input type="text" id="newCategory" required></label>
      <button type="submit">新增類別</button>
    </form>
    <div class="message" id="addCategoryMsg"></div>

    <h3>刪除類別</h3>
    <form id="deleteCategoryForm">
      <label>類型<select id="delType"><option value="收入">收入</option><option value="支出">支出</option></select></label>
      <label>選擇類別<select id="delCategory" required></select></label>
      <button type="submit">刪除類別</button>
    </form>
    <div class="message" id="delCategoryMsg"></div>
    <button class="toggle-btn" onclick="switchTo('input')">🔙 返回輸入頁</button>
  </div>

  <div id="recordsSection" class="section">
    <h2>記帳紀錄查詢</h2>
    <label>選擇月份：<input type="month" id="monthPicker"></label>
    <div class="filter">
      <label>篩選類型：<select id="filterType"><option value="">全部</option><option value="收入">收入</option><option value="支出">支出</option></select></label>
      <label>篩選類別：<select id="filterCategory"><option value="">全部</option></select></label>
      <label>篩選日期：<input type="date" id="filterDate"></label>
    </div>
    <table id="recordTable">
      <thead>
        <tr><th>日期</th><th>帳戶</th><th>類別</th><th>金額</th><th>內容</th><th>類型</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="toggle-btn" onclick="switchTo('input')">🔙 返回輸入頁</button>
  </div>
  <script>
    let incomeCategories = [], expenseCategories = [], allRecords = [];
    let isSubmitting = false, isAdding = false, isDeleting = false;

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date').valueAsDate = new Date();
      const ym = new Date().toISOString().slice(0, 7);
      document.getElementById('monthPicker').value = ym;
      google.script.run.withSuccessHandler(displayRecords).getMonthlyRecords(ym);
      google.script.run.withSuccessHandler(data => {
        incomeCategories = data.incomeCategories;
        expenseCategories = data.expenseCategories;
        fillSelect('account', data.accounts);
        updateCategoryOptions();
        updateDeleteSelect();
        updateFilterCategorySelect();
      }).getFormOptions();
      loadBalances();

      document.getElementById('type').addEventListener('change', updateCategoryOptions);
      document.getElementById('delType').addEventListener('change', updateDeleteSelect);
      document.getElementById('addCategoryForm').addEventListener('submit', e => {
  e.preventDefault();
  if (isAdding) return;
  isAdding = true;
  const btn = document.querySelector('#addCategoryForm button');
  btn.disabled = true;
  btn.textContent = '新增中...';
  const type = document.getElementById('newType').value;
  const name = document.getElementById('newCategory').value.trim();
  if (!name) {
    btn.disabled = false;
    btn.textContent = '新增類別';
    isAdding = false;
    return;
  }
  google.script.run.withSuccessHandler(msg => {
    document.getElementById('addCategoryMsg').textContent = msg;
    document.getElementById('addCategoryForm').reset();
    google.script.run.withSuccessHandler(data => {
      incomeCategories = data.incomeCategories;
      expenseCategories = data.expenseCategories;
      updateCategoryOptions();
      updateDeleteSelect();
      updateFilterCategorySelect(); // ✅ 更新紀錄頁的下拉選單
      btn.disabled = false;
      btn.textContent = '新增類別';
      isAdding = false;
    }).getFormOptions();
  }).addCategory(type, name);
});
document.getElementById('deleteCategoryForm').addEventListener('submit', e => {
  e.preventDefault();
  if (isDeleting) return;
  isDeleting = true;
  const btn = document.querySelector('#deleteCategoryForm button');
  btn.disabled = true;
  btn.textContent = '刪除中...';
  const type = document.getElementById('delType').value;
  const name = document.getElementById('delCategory').value;
  if (!name || !confirm(`確定要刪除「${name}」這個${type}類別嗎？`)) {
    btn.disabled = false;
    btn.textContent = '刪除類別';
    isDeleting = false;
    return;
  }
  google.script.run.withSuccessHandler(msg => {
    document.getElementById('delCategoryMsg').textContent = msg;
    google.script.run.withSuccessHandler(data => {
      incomeCategories = data.incomeCategories;
      expenseCategories = data.expenseCategories;
      updateCategoryOptions();
      updateDeleteSelect();
      updateFilterCategorySelect(); // ✅ 更新紀錄頁類別下拉
      btn.disabled = false;
      btn.textContent = '刪除類別';
      isDeleting = false;
    }).getFormOptions();
  }).deleteCategory(type, name);
});

      document.getElementById('filterType').addEventListener('change', () => {
        updateFilterCategorySelect();
        filterRecords();
      });
      document.getElementById('filterCategory').addEventListener('change', filterRecords);
      document.getElementById('filterDate').addEventListener('input', filterRecords);

      document.getElementById('form').addEventListener('submit', e => {
        e.preventDefault();
        if (isSubmitting) return;
        isSubmitting = true;
        const btn = document.querySelector('#form button');
        btn.disabled = true;
        btn.textContent = '提交中...';
        const data = {
          type: document.getElementById('type').value,
          date: document.getElementById('date').value,
          account: document.getElementById('account').value,
          category: document.getElementById('category').value,
          amount: parseFloat(document.getElementById('amount').value),
          note: document.getElementById('note').value
        };
        google.script.run.withSuccessHandler(msg => {
          document.getElementById('message').textContent = msg;
          document.getElementById('form').reset();
          document.getElementById('date').valueAsDate = new Date();
          updateCategoryOptions();
          loadBalances();
          btn.disabled = false;
          btn.textContent = '提交';
          isSubmitting = false;
        }).submitForm(data);
      });

      document.getElementById('monthPicker').addEventListener('change', () => {
        const month = document.getElementById('monthPicker').value;
        if (month) {
          google.script.run.withSuccessHandler(displayRecords).getMonthlyRecords(month);
        }
      });
    });

    function fillSelect(id, options) {
      const select = document.getElementById(id);
      select.innerHTML = '';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

function updateCategoryOptions() {
  const type = document.getElementById('type').value;
  fillSelect('category', type === '收入' ? incomeCategories : expenseCategories);
  updateCategoryButtons(); // ⬅️ 加在這裡，確保分類按鈕與 select 同步
}
// ⬇️ 接著插入 emoji 對應與分類按鈕建構函式
const emojiMap = {
  // 收入類別
  '薪水': '💰',
  '兼職費': '👨‍💼',
  '加班費': '⏰',
  '兼課費': '📚',
  '其他': '🪙',

  // 支出類別
  '飲食': '🍱',
  '住家': '🏠',
  '交通': '🚌',
  '娛樂': '🎮',
  '保健': '💊',
  '寵物': '🐾',
  '工作代墊': '🧾',
  '投資': '📈',
  '日用品': '🧻'
};

function updateCategoryButtons() {
  const type = document.getElementById('type').value;
  const categoryList = type === '收入' ? incomeCategories : expenseCategories;
  const container = document.getElementById('categoryButtons');
  const select = document.getElementById('category');

  container.innerHTML = '';
  select.innerHTML = '';

  categoryList.forEach(cat => {
    const emoji = emojiMap[cat] || '📂';
    const btn = document.createElement('div');
    btn.className = 'category-btn';
    btn.innerHTML = `${emoji}<br>${cat}`;
    btn.dataset.value = cat;

    btn.addEventListener('click', () => {
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      select.value = cat;
    });

    container.appendChild(btn);

    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });

  if (categoryList.length > 0) {
    container.querySelector('.category-btn')?.click();
  }
}

    function updateDeleteSelect() {
      const type = document.getElementById('delType').value;
      fillSelect('delCategory', type === '收入' ? incomeCategories : expenseCategories);
    }

    function updateFilterCategorySelect() {
      const type = document.getElementById('filterType').value;
      const select = document.getElementById('filterCategory');
      let list = [];
      if (type === '收入') list = incomeCategories;
      else if (type === '支出') list = expenseCategories;
      select.innerHTML = '<option value="">全部</option>' + list.map(opt => `<option value="${opt}">${opt}</option>`).join('');
    }

    function loadBalances() {
      google.script.run.withSuccessHandler(displayBalances).getAccountBalances();
    }

    function displayBalances(accounts) {
      const container = document.getElementById('balances');
      if (accounts.length === 0) {
        container.textContent = '無帳戶資料';
        return;
      }
      container.innerHTML = accounts.map(acc =>
        `<div class="card">
          <div class="card-title">${acc.name}</div>
          <div class="card-balance">$${Number(acc.balance).toLocaleString()}</div>
        </div>`
      ).join('');
    }

    function displayRecords(data) {
      allRecords = data;
      filterRecords();
    }

    function filterRecords() {
      const type = document.getElementById('filterType').value;
      const category = document.getElementById('filterCategory').value;
      const date = document.getElementById('filterDate').value;
      const filtered = allRecords.filter(r => {
        return (!type || r.type === type) && (!category || r.category === category) && (!date || r.date === date);
      });
      const tbody = document.querySelector('#recordTable tbody');
      tbody.innerHTML = '';
      if (filtered.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" style="text-align:center; color:gray;">此月份無資料</td>';
        tbody.appendChild(row);
        return;
      }
      filtered.forEach(r => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${r.date}</td>
          <td>${r.account}</td>
          <td>${r.category}</td>
          <td>$${Number(r.amount).toLocaleString()}</td>
          <td>${r.note}</td>
          <td>${r.type}</td>`;
        tbody.appendChild(row);
      });
    }
function switchTo(section) {
  document.querySelectorAll('.section').forEach(div => div.classList.remove('active'));
  document.getElementById(section + 'Section').classList.add('active');

  if (section === 'records') {
    const month = document.getElementById('monthPicker')?.value || new Date().toISOString().slice(0, 7);
    google.script.run.withSuccessHandler(displayRecords).getMonthlyRecords(month);
  }

  if (section === 'balances') {
    loadBalances();
  }

  if (section === 'category') {
    google.script.run.withSuccessHandler(data => {
      incomeCategories = data.incomeCategories;
      expenseCategories = data.expenseCategories;
      updateDeleteSelect();
    }).getFormOptions();
  }
}

if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker 註冊成功'))
        .catch(err => console.error('Service Worker 註冊失敗:', err));
    }
  </script>
</body>
</html>
