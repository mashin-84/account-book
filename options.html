<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#666666" />
  <title>é¸é …è¨­å®š</title>
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      padding: 40px;
      font-size: 28px;
      background: #fff;
      color: #222;
    }
    h2 {
      font-size: 38px;
      margin-bottom: 30px;
    }
    h3 {
      font-size: 32px;
      margin-top: 40px;
    }
    label {
      display: block;
      margin-top: 24px;
    }
    input, button, select {
      width: 100%;
      font-size: 26px;
      padding: 18px;
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #666;
      color: #fff;
      border: none;
      margin-top: 16px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #444;
    }
    ul {
      margin-top: 10px;
      padding-left: 25px;
    }
    li {
      margin-bottom: 8px;
    }
    .toggle-btn {
      background: #f0f0f0;
      color: #666;
      font-weight: bold;
      font-size: 26px;
      margin-top: 30px;
      padding: 18px;
      border-radius: 12px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    .balances {
      margin-top: 30px;
      background: #f8f8f8;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h2>âš™ï¸ é¸é …è¨­å®š</h2>

  <h3>ğŸ”§ ç·¨è¼¯å¸³æˆ¶èˆ‡é¡åˆ¥</h3>

  <button class="toggle-btn" onclick="toggleSection('accountSection')">ğŸ“‚ å¸³æˆ¶ç®¡ç†</button>
  <div id="accountSection" style="display: none;">
    <label>å¸³æˆ¶åç¨± <input type="text" id="newAccount" /></label>
    <button onclick="addAccount()">â• æ–°å¢å¸³æˆ¶</button>
    <ul id="accountListDisplay"></ul>
  </div>

  <button class="toggle-btn" onclick="toggleSection('incomeSection')">ğŸ“‚ æ”¶å…¥é¡åˆ¥ç®¡ç†</button>
  <div id="incomeSection" style="display: none;">
    <label>æ”¶å…¥é¡åˆ¥ <input type="text" id="newIncomeCat" /></label>
    <button onclick="addIncomeCategory()">â• æ–°å¢æ”¶å…¥é¡åˆ¥</button>
    <ul id="incomeCatListDisplay"></ul>
  </div>

  <button class="toggle-btn" onclick="toggleSection('expenseSection')">ğŸ“‚ æ”¯å‡ºé¡åˆ¥ç®¡ç†</button>
  <div id="expenseSection" style="display: none;">
    <label>æ”¯å‡ºé¡åˆ¥ <input type="text" id="newExpenseCat" /></label>
    <button onclick="addExpenseCategory()">â• æ–°å¢æ”¯å‡ºé¡åˆ¥</button>
    <ul id="expenseCatListDisplay"></ul>
  </div>

  <button class="toggle-btn" onclick="loadBalances()">ğŸ’° æŸ¥è©¢å¸³æˆ¶é¤˜é¡</button>
  <div class="balances" id="balanceDisplay">ğŸ’° å¸³æˆ¶é¤˜é¡å°‡é¡¯ç¤ºåœ¨é€™è£¡</div>

  <label>ğŸ“… é¸æ“‡æŸ¥è©¢æœˆä»½
    <input type="month" id="queryMonth" style="margin-top: 10px;" />
  </label>
  <button class="toggle-btn" onclick="showLocalRecords()">ğŸ“‚ æŸ¥çœ‹æœ¬æ©Ÿè³‡æ–™</button>
  <button class="toggle-btn" onclick="showCloudRecords()">â˜ï¸ æŸ¥çœ‹é›²ç«¯è³‡æ–™</button>
  <div class="balances" id="recordDisplay">ğŸ“… è³‡æ–™å°‡é¡¯ç¤ºåœ¨é€™è£¡</div>

  <script>
    const STORAGE_KEY = 'fastbook-records';
    const GAS_URL = 'https://mashin.t0884.workers.dev';

    document.addEventListener('DOMContentLoaded', () => {
      const ym = new Date().toISOString().slice(0, 7);
      document.getElementById('queryMonth').value = ym;
      loadFormOptions();
      checkNotifications(); // âœ… æª¢æŸ¥å›ºå®šæ”¯å‡ºé€šçŸ¥
    });

    function toggleSection(id) {
      const section = document.getElementById(id);
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    function loadFormOptions() {
      fetch(`${GAS_URL}/?action=getFormOptions`)
        .then(res => res.json())
        .then(options => {
          showList('accountListDisplay', options.accounts, deleteAccount);
          showList('incomeCatListDisplay', options.incomeCategories, name => deleteCategory('æ”¶å…¥', name));
          showList('expenseCatListDisplay', options.expenseCategories, name => deleteCategory('æ”¯å‡º', name));
        });
    }

    function showList(containerId, items, deleteFn) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item + ' ';
        const btn = document.createElement('button');
        btn.textContent = 'âŒ';
        btn.onclick = () => {
          if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item}ã€å—ï¼Ÿ`)) deleteFn(item);
        };
        li.appendChild(btn);
        container.appendChild(li);
      });
    }

    function addAccount() {
      const name = document.getElementById('newAccount').value.trim();
      if (!name) return alert('è«‹è¼¸å…¥å¸³æˆ¶åç¨±');
      fetch(`${GAS_URL}/?action=addAccount&name=${encodeURIComponent(name)}`)
        .then(res => res.text())
        .then(alert)
        .then(() => {
          document.getElementById('newAccount').value = '';
          loadFormOptions();
        });
    }

    function addIncomeCategory() {
      const name = document.getElementById('newIncomeCat').value.trim();
      if (!name) return alert('è«‹è¼¸å…¥æ”¶å…¥é¡åˆ¥åç¨±');
      fetch(`${GAS_URL}/?action=addCategory&type=æ”¶å…¥&name=${encodeURIComponent(name)}`)
        .then(res => res.text())
        .then(alert)
        .then(() => {
          document.getElementById('newIncomeCat').value = '';
          loadFormOptions();
        });
    }

    function addExpenseCategory() {
      const name = document.getElementById('newExpenseCat').value.trim();
      if (!name) return alert('è«‹è¼¸å…¥æ”¯å‡ºé¡åˆ¥åç¨±');
      fetch(`${GAS_URL}/?action=addCategory&type=æ”¯å‡º&name=${encodeURIComponent(name)}`)
        .then(res => res.text())
        .then(alert)
        .then(() => {
          document.getElementById('newExpenseCat').value = '';
          loadFormOptions();
        });
    }

    function deleteAccount(name) {
      fetch(`${GAS_URL}/?action=deleteAccount&name=${encodeURIComponent(name)}`)
        .then(res => res.text())
        .then(alert)
        .then(loadFormOptions);
    }

    function deleteCategory(type, name) {
      fetch(`${GAS_URL}/?action=deleteCategory&type=${encodeURIComponent(type)}&name=${encodeURIComponent(name)}`)
        .then(res => res.text())
        .then(alert)
        .then(loadFormOptions);
    }

    function loadBalances() {
      document.getElementById('balanceDisplay').textContent = 'â³ æŸ¥è©¢ä¸­...';
      fetch(`${GAS_URL}/balance`)
        .then(res => res.json())
        .then(data => {
          const html = data.map(acc => `<div>${acc.name}ï¼š$${Number(acc.balance).toLocaleString()}</div>`).join('');
          document.getElementById('balanceDisplay').innerHTML = 'ğŸ’° å„å¸³æˆ¶é¤˜é¡ï¼š<br>' + html;
        })
        .catch(() => {
          document.getElementById('balanceDisplay').textContent = 'âš ï¸ ç„¡æ³•å–å¾—å¸³æˆ¶é¤˜é¡';
        });
    }

    function showLocalRecords() {
      const display = document.getElementById('recordDisplay');
      const month = document.getElementById('queryMonth').value;
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      const filtered = data.filter(r => r.date?.startsWith(month));
      if (!month) return display.textContent = 'âš ï¸ è«‹å…ˆé¸æ“‡æŸ¥è©¢çš„æœˆä»½';
      if (data.length === 0) return display.textContent = 'ğŸ“‚ æœ¬æ©Ÿæ²’æœ‰ä»»ä½•è³‡æ–™';
      if (filtered.length === 0) return display.textContent = `ğŸ“­ æœ¬æ©Ÿåœ¨ ${month} ç„¡è³‡æ–™`;

      let html = `<h3>${month} æœ¬æ©Ÿè³‡æ–™</h3><ul style="padding-left:20px;">`;
      filtered.forEach(r => {
        html += `<li>ğŸ“Œ ${r.date}ï½œ${r.account}ï½œ${r.category}ï½œ$${r.amount}ï½œ${r.note || ''}ï½œ${r.type}</li>`;
      });
      html += '</ul>';
      display.innerHTML = html;
    }

    function showCloudRecords() {
      const display = document.getElementById('recordDisplay');
      const month = document.getElementById('queryMonth').value;
      if (!month) return display.textContent = 'âš ï¸ è«‹å…ˆé¸æ“‡æŸ¥è©¢çš„æœˆä»½';

      display.innerHTML = 'â˜ï¸ é›²ç«¯è³‡æ–™è®€å–ä¸­...';
      fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'getMonthlyRecords', month })
      })
        .then(res => res.json())
        .then(records => {
          if (!records || records.length === 0) {
            display.innerHTML = `ğŸ“­ ${month} é›²ç«¯è³‡æ–™ç‚ºç©º`;
            return;
          }
          let html = `<h3>${month} é›²ç«¯è³‡æ–™</h3><ul style="padding-left:20px;">`;
          records.forEach(r => {
            html += `<li>â˜ï¸ ${r.date}ï½œ${r.account}ï½œ${r.category}ï½œ$${r.amount}ï½œ${r.note || ''}ï½œ${r.type}</li>`;
          });
          html += '</ul>';
          display.innerHTML = html;
        })
        .catch(() => {
          display.innerHTML = 'âš ï¸ ç„¡æ³•å–å¾—é›²ç«¯è³‡æ–™';
        });
    }

    // âœ… æª¢æŸ¥å›ºå®šæ”¯å‡ºé€šçŸ¥
    function checkNotifications() {
  fetch(`${GAS_URL}/?action=getNotifications`)
    .then(res => res.json())
    .then(list => {
      if (list.length > 0) {
        const msg = list.join('\n');
        alert(`ğŸ“¢ å›ºå®šæ”¯å‡ºå·²æ‰£æ¬¾ï¼š\n${msg}`);
        fetch(`${GAS_URL}/?action=clearNotifications`);
      }
    })
    .catch(() => {
      console.warn('ğŸ”• ç„¡æ³•å–å¾—é€šçŸ¥');
    });
}

  </script>
</body>
</html>

